<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.cart">

  <!-- 장바구니 리절트 맵 -->
  <resultMap id="cartResult" type="CartVO">
    <result property="cart_id" column="cart_id"/>
    <result property="member_id" column="member_id"/>
    <result property="goods_num" column="goods_num"/>
    <result property="cart_goods_qty" column="cart_goods_qty"/>
    <result property="creDate" column="creDate"/>
  </resultMap>

  <!-- 상품 정보 리절트 맵 -->
  <resultMap id="goodsResult" type="GoodsVO">
    <result property="goods_num" column="goods_num"/>
    <result property="goods_num" column="goods_num"/>
    <result property="goods_maker" column="goods_maker"/>
    <result property="goods_category" column="goods_category"/>
    <result property="goods_price" column="goods_price"/>
    <result property="goods_sales_price" column="goods_sales_price"/>
    <result property="goods_point" column="goods_point"/>
    <result property="goods_stock" column="goods_stock"/>
    <result property="goods_delivery_price" column="goods_delivery_price"/>
    <result property="goods_fileName" column="goods_fileName"/>
    <result property="goods_status" column="goods_status"/>
    <result property="goods_goods_writer_intro" column="goods_goods_writer_intro"/>
    <result property="goods_contents_order" column="goods_contents_order"/>
    <result property="goods_credate" column="goods_credate"/>
  </resultMap>

  <!-- 회원 장바구니 목록 조회 -->
  <select id="selectCartList" parameterType="cartVO" resultMap="cartResult">
    <![CDATA[
      select cart_id, member_id, goods_num, cart_goods_qty, creDate 
      from cart
      where member_id = #{member_id}
    ]]>
  </select>

  <!-- 장바구니 내 상품 정보 가져오기 (대표 이미지 포함) -->
  <select id="selectGoodsList" resultMap="goodsResult" parameterType="java.util.Map">
    <![CDATA[
      select g.*
      from goods g
      where g.goods_num in
    ]]>
    <foreach item="item" collection="list" open="(" separator="," close=")">
      #{item.goods_num}
    </foreach>
    <![CDATA[
      order by g.goods_credate desc
    ]]>
  </select>

  <!-- 장바구니에 해당 상품이 있는지 확인 -->
  <select id="selectCountInCart" resultType="int" parameterType="cartVO">
    <![CDATA[
      select count(*) from cart
      where goods_num = #{goods_num}
        and member_id = #{member_id}
    ]]>
  </select>

  <!-- 장바구니에 상품 추가 -->
  <insert id="insertGoodsInCart" parameterType="cartVO">
  <![CDATA[
    insert into cart(cart_id, goods_num, member_id, cart_goods_qty)
    values(#{cart_id}, #{goods_num}, #{member_id}, #{cart_goods_qty})
  ]]>
</insert>


  <!-- 장바구니 상품 수량 변경 -->
  <update id="updateCartGoodsQty" parameterType="cartVO">
    <![CDATA[
      update cart
      set cart_goods_qty = #{cart_goods_qty}
      where member_id = #{member_id}
        and goods_num = #{goods_num}
    ]]>
  </update>

  <!-- 장바구니 상품 삭제 -->
  <delete id="deleteCartGoods" parameterType="int">
    <![CDATA[
      delete from cart
      where cart_id = #{cart_id}
    ]]>
  </delete>

  <!-- 장바구니 ID 최대값 +1 구하기 (자동 증가용) -->
  <select id="selectMaxCartId" resultType="int">
    <![CDATA[
      SELECT IFNULL(MAX(cart_id), 0) + 1 FROM cart
    ]]>
  </select>
  
  <update id="increaseCartQty" parameterType="CartVO">
    UPDATE cart
    SET cart_goods_qty = cart_goods_qty + 1
    WHERE member_id = #{member_id} AND goods_num = #{goods_num}
</update>

</mapper>
