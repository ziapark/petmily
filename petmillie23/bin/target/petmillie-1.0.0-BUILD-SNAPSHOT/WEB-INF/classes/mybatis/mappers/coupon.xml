<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.coupon">

  <!-- 쿠폰 ResultMap -->
  <resultMap id="couponResult" type="CouponVO">
    <result property="coupon_id" column="coupon_id"/>
    <result property="coupon_name" column="coupon_name"/>
    <result property="coupon_code" column="coupon_code"/>
    <result property="discount_type" column="discount_type"/>
    <result property="discount_value" column="discount_value"/>
    <result property="min_order_amount" column="min_order_amount"/>
    <result property="max_discount_amount" column="max_discount_amount"/>
    <result property="expire_date" column="expire_date"/>
    <result property="description" column="description"/>
    <result property="reg_date" column="reg_date"/>
    <result property="issued_by" column="issued_by"/>
  </resultMap>

  <!-- 사용자 쿠폰 ResultMap -->
  <resultMap id="userCouponResult" type="UserCouponVO">
    <result property="user_coupon_id" column="user_coupon_id"/>
    <result property="coupon_id" column="coupon_id"/>
    <result property="member_id" column="member_id"/>
    <result property="issued_date" column="issued_date"/>
    <result property="used_yn" column="used_yn"/>
    <result property="used_date" column="used_date"/>
    <result property="available_yn" column="available_yn"/>
  </resultMap>

  <!-- 쿠폰 등록 -->
  <insert id="insertCoupon" parameterType="CouponVO">
    INSERT INTO coupon (
      coupon_name, coupon_code, discount_type, discount_value,
      min_order_amount, max_discount_amount, expire_date, description, reg_date, issued_by
    ) VALUES (
      #{coupon_name}, #{coupon_code}, #{discount_type}, #{discount_value},
      #{min_order_amount}, #{max_discount_amount}, #{expire_date}, #{description}, NOW(), #{issued_by}
    )
    <selectKey resultType="int" keyProperty="coupon_id" order="AFTER">
      SELECT LAST_INSERT_ID()
    </selectKey>
  </insert>

  <!-- 회원에게 쿠폰 지급 -->
  <insert id="insertUserCoupon" parameterType="UserCouponVO">
    INSERT INTO user_coupon (
      coupon_id, member_id, issued_date, used_yn, used_date, available_yn
    ) VALUES (
      #{coupon_id}, #{member_id}, NOW(), 'N', NULL, 'Y'
    )
    <selectKey resultType="int" keyProperty="user_coupon_id" order="AFTER">
      SELECT LAST_INSERT_ID()
    </selectKey>
  </insert>

  <!-- 쿠폰 목록 조회 -->
  <select id="selectCouponList" resultMap="couponResult">
    SELECT * FROM coupon ORDER BY reg_date DESC
  </select>

  <!-- 사용자 보유 쿠폰 목록 조회 -->
  <select id="selectUserCouponList" resultMap="userCouponResult" parameterType="string">
    SELECT uc.*, c.coupon_name, c.discount_type, c.discount_value, c.expire_date
    FROM user_coupon uc
    INNER JOIN coupon c ON uc.coupon_id = c.coupon_id
    WHERE uc.member_id = #{member_id}
    ORDER BY uc.issued_date DESC
  </select>

  <!-- 쿠폰 사용 처리 -->
  <update id="useUserCoupon" parameterType="int">
    UPDATE user_coupon
    SET used_yn = 'Y', used_date = NOW(), available_yn = 'N'
    WHERE user_coupon_id = #{user_coupon_id}
  </update>

  <!-- 단일 쿠폰 상세 조회 -->
  <select id="selectCouponDetail" resultMap="couponResult" parameterType="int">
    SELECT * FROM coupon WHERE coupon_id = #{coupon_id}
  </select>

</mapper>
