<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 네임스페이스를 DAO에서 호출하는 경로와 일치시킵니다. -->
<mapper namespace="mapper.reservation">

	<!-- =================== 기존 코드 유지 =================== -->
	<resultMap id="pensionDetailResult" type="com.petmillie.business.vo.PensionVO">
		<result property="p_num" column="p_num" />
		<result property="business_id" column="business_id" />
		<result property="p_name" column="p_name" />
		<result property="tel1" column="tel1" />
		<result property="tel2" column="tel2" />
		<result property="tel3" column="tel3" />
		<result property="checkin_time" column="checkin_time" />
		<result property="checkout_time" column="checkout_time" />
		<result property="facilities" column="facilities" />
		<result property="description" column="description" />
		
		<association property="business" javaType="com.petmillie.business.vo.BusinessVO">
			<result property="roadAddress" column="roadAddress"/>
			<result property="jibunAddress" column="jibunAddress"/>
		</association>
	</resultMap>

	<resultMap id="roomResult" type="com.petmillie.business.vo.RoomVO">
		<result property="room_id" column="room_id"/>
		<result property="p_num" column="p_num"/>
		<result property="room_name" column="room_name"/>
		<result property="room_type" column="room_type"/>
		<result property="price" column="price"/>
		<result property="max_capacity" column="max_capacity"/>
		<result property="bed_type" column="bed_type"/>
		<result property="room_size" column="room_size"/>
		<result property="room_description" column="room_description"/>
		<result property="amenities" column="amenities"/>
		<result property="reg_date" column="reg_date"/>
		<result property="del_yn" column="del_yn"/>
		<result property="fileimage" column="fileimage"/>
	</resultMap>
	
	<!-- [추가] ReservationDTO를 위한 resultMap -->
	<resultMap id="reservationResult" type="com.petmillie.reservation.vo.ReservationDTO">
		<result property="reservation_id" column="reservation_id"/>
		<result property="member_id" column="member_id"/>
		<result property="business_id" column="business_id"/>
		<result property="room_id" column="room_id"/>
		<result property="checkin_date" column="checkin_date"/>
		<result property="checkout_date" column="checkout_date"/>
		<result property="guests" column="guests"/>
		<result property="reserver_name" column="reserver_name"/>
		<result property="reserver_tel" column="reserver_tel"/>
		<result property="total_price" column="total_price"/>
		<result property="status" column="status"/>
	</resultMap>

	<select id="selectAllPensionList" resultType="com.petmillie.business.vo.PensionVO">
		<![CDATA[
			SELECT * FROM pension WHERE del_yn = 'N' ORDER BY p_num DESC
		]]>
	</select>
	
	<select id="selectPensionDetail" resultMap="pensionDetailResult" parameterType="int">
		<![CDATA[
			SELECT
				p.*, b.roadAddress, b.jibunAddress
			FROM
				pension p
			JOIN
				business b ON p.business_id = b.business_id
			WHERE
				p.p_num = #{p_num}
		]]>
	</select>

	<select id="selectRoomList" resultMap="roomResult" parameterType="int">
		<![CDATA[
			SELECT * FROM room WHERE p_num = #{p_num} AND del_yn = 'N' ORDER BY price ASC
		]]>
	</select>

	<!-- 특정 객실 상세 정보 조회 -->
	<select id="selectRoomDetail" resultMap="roomResult" parameterType="int">
		<![CDATA[
			SELECT * FROM room
			WHERE room_id = #{roomId}
		]]>
	</select>
	
	<!-- 예약 정보 추가 -->
	<insert id="insertReservation" 
			parameterType="com.petmillie.reservation.vo.ReservationDTO"
			useGeneratedKeys="true"
			keyProperty="reservation_id">
		<![CDATA[
			INSERT INTO reservation(
				member_id,
				business_id,
				room_id,
				checkin_date,
				checkout_date,
				guests,
				reserver_name,
				reserver_tel,
				total_price,
				status
			)
			VALUES (
				#{member_id},
				#{business_id},
				#{room_id},
				#{checkin_date},
				#{checkout_date},
				#{guests},
				#{reserver_name},
				#{reserver_tel},
				#{total_price},
				'예약완료'
			)
		]]>
	</insert>
	
	<!-- 
	  ===================================================================
	  ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼ [ 신규 쿼리 1개 추가 ] ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
	  ===================================================================
	-->
	
	<!-- [추가] 사업자 ID로 예약 목록 조회 -->
	<select id="selectReservationsByBusinessId" resultMap="reservationResult" parameterType="String">
		<![CDATA[
			SELECT * FROM reservation
			WHERE business_id = #{business_id}
			ORDER BY checkin_date DESC
		]]>
	</select>
	
</mapper>
